<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鯉カメラ</title>
  </head>
  <body>
    {% extends "bootstrap/base.html" %}

    {% block navbar %}
    <div class="navbar navbar-fixed-top">
      <!-- ... -->
    </div>
    {% endblock %}

    {% block content %}
    <div>
        <div class="text-center">
          <img decoding="async" id="image" src="" width="810" height="540"/>
        </div>
        <div class="text-center">
          <button type="button" class="btn btn-primary btn-lg"
          style="margin: 5px;"
          onclick="downloadImage()">ダウンロード</button>
        </div>
    </div>

    <script>
      let base64Image = '' // base64に変換された画像

      // flaskで作成したAPIから画像を取得する
      fetch('/image')
      .then(function (response) {
        return response.json();
      }).then(function (text) {
        base64Image = 'data:image/jpg;base64,' + text.image;
        // imgに反映させて表示
        const img = document.getElementById('image');
        img.src = base64Image;
      });

      // 画像のダウンロードを行わせる
      downloadImage = () => {
        //画像をImage型に変換
        const downloadImage = new Image();
        downloadImage.src = base64Image;
        // キャンバスに画像を描画する
        const canvas = document.createElement('canvas');
        canvas.width = 810;
        canvas.height= 540;
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(downloadImage, 0, 0);
        // 画像のダウンロードリンクを作成
        const link = document.createElement('a');
        link.download = 'koicamera.jpg';
        canvas.toBlob(function(blob) {
          // リンクのクリックイベントを発火させることでダウンロードさせられる
          link.href = URL.createObjectURL(blob);
          link.click();
        });
      }
    </script>
    {% endblock %}
  </body>
</html>