<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>鯉カメラ</title>
</head>
<body>
  {% extends "bootstrap/base.html" %}

  {% block navbar %}
  <div class="navbar navbar-fixed-top">
    <!-- ... -->
  </div>
  {% endblock %}

  {% block content %}
  <div>
    <div class="text-center">
      <img src='/video'>
    </div>
    <div class="text-center">
      <form action="/save" method="GET">
        <input type="submit" class="btn btn-primary btn-lg" value="写真撮影"
        style="margin: 10px;">
      </form>
    </div>
    <div class="text-center">
      <h4 style="margin-top: 40px;">変換先選択</h4>
      <button type="button" class="btn btn-primary btn-lg"
            style="margin: 5px;"
            onclick="changeImage('esa_agenaide')">鯉</button>
      <button type="button" class="btn btn-primary btn-lg"
            style="margin: 5px;"
            onclick="changeImage('realkoi')">鯉（リアル）</button>
      <button type="button" class="btn btn-primary btn-lg"
            style="margin: 5px;"
            onclick="changeImage('tai')">鯛</button>
    </div>
  </div>
  <script>
    changeImage = (imageName) => {
      // flaskで作成したAPIから画像を変更する
      fetch('/koiChange/' + imageName)
      .then(function (response) {
        windows.alart('change')
        return;
      });
    }
    //function success(pos){
      //console.log('pos');
    //}
    //function fail(error){
      //window.alert('位置情報の取得に失敗しました。エラーコード：' + error.code);
    //}
    //成功した時にsuccess function　失敗した時にfail functionを呼び出せるように定義しておく
    //navigator.geolocation.getCurrentPosition(success,fail);
    var stream;
    var video;

    navigator.mediaDevices.getUserMedia({video: true, audio: false}).then(async function (stream) {
      stream = stream;
      video = document.getElementById('video');
      video.src = window.URL.createObjectURL(stream);
      video.play();
      while(true){
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        await setTimeout(async function() {
          var w = video.offsetWidth;
          var h = video.offsetHeight;
          canvas.setAttribute('width', w);
          canvas.setAttribute('height', h);
          ctx.drawImage(video, 0, 0, w, h);
          canvas.toBlob(async function(blob) {
            var img = document.getElementById('image');
            img.src = window.URL.createObjectURL(blob);
            await fetch('/videomake' , {
              method: 'POST', // メソッド
              header: { // ヘッダー指定
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(img) // 送信データをセット（ここでJSON形式に変換）
            })
            .then(function (response) {
              return;
            });
          }, 'image/jpeg', 0.95);
          stream.getTracks()[0].stop();
        }, 1000);
      }

    }).catch(function (error) {
      console.error('mediaDevice.getUserMedia() error:', error);
      return;
    });
  </script>
  {% endblock %}
</body>
</html>